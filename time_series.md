# 时间序列分析

规律性时间间隔上记录数据的序列称为时间序列；

> 时间序列一般形式：
> 加法时间序列 = 基线水平+趋势+季节性+误差
> 乘法时间序列 = 基线水平\*趋势\*季节性*误差

时间序列的4种形式
> 1. 随机游走：$y_t = y_{t-1} + u_t$
> 2. 随机趋势过程：$y_t = \alpha + y_{t-1} + u_t = \alpha*t + y_0 + \sum{u_t}$,  $ \alpha*t $是趋势项。
> 3. 趋势平稳过程（非平稳序列）：$ y_t = \beta_0 + \beta_1*t + u_t $, $\beta_0 + \beta_1*t$为趋势项。
> 4. 趋势非平稳过程：$y_t = \beta_0 + \alpha*t + y_{t-1} + u_t$


## 一、时间序列的平稳性

### 为什么要求是平稳时间序列？
> 1. 要求平稳性序列的目标还是希望能更好的预测未来，非平稳序列在规律上杂乱无章，规律性比较低甚至无规律可循。而平稳序列在相关性上有一定的规律，甚至能延续下去，进而能利用这么规则帮助预测未来。
> 2. 时间序列分析中的许多方法，如ARMA、ARIMA、Granger因果检验等时序预测和分析方法，都需要时间序列具备平稳性。

### 如何理解时间平稳性？
> 1. 时间序列的平稳性是指一组时间序列数据看起来平坦，各阶统计特征（如均值、方差、协方差...）不随时间的变化而变化。
> 2. 其数学定义又分为严平稳和宽平稳。所谓严平稳 (strictly stationary) 就是一种条件比较苛刻的平稳性定义，它认为只有序列所有的统计性质都不会随着时间的推移而发生变化时该序列才能被认为是严平稳。宽平稳 (weak stationary) 是使用序列的特征统计量来定义的这种平稳性。它认为序列的统计性质主要由它的低阶矩决定，所以只要保证序列低阶矩平稳，就能保证序列的主要性质近似稳定。均值和方差表示一阶矩和二阶矩。
> 3. 在判断平稳性上，下面这个例子容易让人混淆：如果一个循环变化的时间序列没有趋势和季节性，那么它仍然是平稳的。这是因为这些循环变化并没有一个固定的周期，因此在进行观测之前我们无法知道循环变化的峰值和谷值会出现在哪个位置。


### 平稳性检验方法
[参考](https://zhuanlan.zhihu.com/p/425664064)

拿到一个时间序列，首先对它进行平稳性和纯随机性的检验的预处理.

1. 时序图检验（图形分析方法）
所谓时序图就是平面二维坐标图，通常横轴表示时间，纵轴表示序列取值。根据平稳时间序列均值，方差为常数的性质，平稳序列的时序图应该显示出该序列始终在一个常数附近随机波动，而且波动的范围有界。如果一个时序图显示明显的趋势或周期性，那它通常不是平稳序列。
![alt 属性文本](C:/ZhangLI/Codes/StudyNotes/pic/time_series.png "时间序列")

2. 分段统计均值和方差
直接将序列前后拆分成2个序列，分别计算这2个序列的均值、方差，对比看是否差异明显。

3. 可视化统计特征（ACF-自相关系数，PACF-偏自相关系数）
绘制时间序列的自相关图和偏相关图。平稳序列会认为自相关性只与时间间隔有关，与时间无关。
现象：平稳序列通常具有短期相关性，平稳序列的自相关系数往往会迅速退化到0（滞后期越短/时间间隔 越短相关性越高，滞后性/时间间隔 为0时，相关性为1）；对于非平稳的序列，退化会发生的很慢，会存在先减后增或周期性波动等变动。
ACF: 
X = [2,3,4,3,8,7];
A = [2,3,4,3,8];
B = [3,4,3,8,7];
$\bar{X} = 1/6*\sum{X}$;
$s^2(X) = \sum{(X_i-\bar{X})^2}$;
$r(1) = \sum{(A-\bar{X})(B-\bar{X})}$;
$ACF(1) = r(1)/ s^2(X)$


4. 检验方法
什么是单位根？
考虑一个简单的模型：
$y_t = \beta_1 y_{t-1} + \epsilon_t $， 其中{$\epsilon_t$}为白噪声。
当 $\vert \beta_1 < 1\vert$时，随着 $t$的增大，$y_t$最终会收敛，长期来看{$y_t$}是平稳的。
当 $ \beta_1 = 1 $时，{$y_t$}为无规律的非平稳的随机游走。
当 $ \beta_1 = 1 $时，{$y_t$}为爆炸式增长的非平稳过程。
$ \beta_1 = 1 $等于1时$ \beta_1 = 1 $就是我们所说的单位根。
> $H_0: $ 原假设 （存在单位根，时间序列是非平稳的）
> $H_1: $ 备择假设 （不存在单位根，时间序列是平稳的--不含截距项和趋势项平稳/含截距项平稳/含截距项和趋势平稳）
* DF-Test（一阶），ADF-Test（高阶）；
* PP-Test
* DF-GLS
* KPSS检验(假设相反)


### 非平稳序列转为平稳性
常用平稳化的方法有：
1. 差分：差分可以去除序列中的趋势和季节性，一阶差分可以去除线性趋势，如果还有二次趋势，还可以二阶差分。二阶差分后还未平稳的话就要注意了，继续差分即便最终平稳了，但是多次差分后解释力下降，且有可能造成过度差分，最差为差分后的序列为白噪声，后面也没法分析了。对于周期型序列也可以用季节差分的方式去除时间序列季节性。
2. 平滑：对当前序列值减去平滑值得到一个残差序列，当平滑结果能比较好的描述原始序列趋势特征的时候，残差序列一般是平稳的，后续可对残差序列进行建模预测。
3. 变换：如对数变换，能够去除方差随时间增长的趋势。对数据进行取log处理，变换前的序列必须满足大于0（小于0的话可以对序列用+x的方式变为正数）。
4. 分解：可以将时间序列分解成3部分：长期趋势、季节变动、不规则波动，3种成分相加叫加法模型，3种成分相乘叫乘法模型，1加1乘叫混合模型。分解目的为去除季节性的影响，分解后可对分解出的趋势项、季节项和余项分别进行预测。常用时间序列分解方法有朴素分解、X11分解、SEATS分解、STL分解等，其中STL分解用的较多。


### 白噪声检测
白噪声完全无自相关性，除0阶自相关系数为1外，理想情况下，延迟k阶的样本自相关系数均为0。实际上由于样本序列的有限性，延迟k阶自相关系数并不完全为0，只要在0值附近即认为无自相关性。

1. 自相关图检验
2. Box-Pierce检验
3. Ljung-Box检验


### 预测方法

1. naive approach 

2. moving average

2.1 simple moving average
$SMA_t(n) = 1/n\sum x_i$

2.2 Weighted Moving Average
$WMA_t(n)= \frac {w_1x_t+w_2x_{t-1}+ ··· +w_3x_{t-2}}{w_1+w_2+···+w_n}$

2.3. Exponential Moving Average
$EMA_t = \frac {x_t+(1-\alpha)x_{t-1}+···} {1+（1-\alpha)+···}$

3. Exponential Smoothing
和ARMA并行为通用的时间预测方法。

3.1 Single Exponential Smoothing
一阶指数平滑：适用于序列没有趋势和季节性特征
预测方程：$ \hat x_{t+1}=s_t$
平滑方程：$s_t = \alpha x_t + (1- \alpha)s_{t-1})$
$ s_t = \alpha x_t + \alpha(1-\alpha)x_{t_1}+\alpha(1-\alpha)^2x_{t-2}+···+\alpha(1-\alpha)^{t-1}x_1+(1-\alpha)^ts_0$

$\alpha$取值范围[0~1],值越大，越关注近期的观测值。当时间序列相对平稳时，取较小的$\alpha$，当时间序列波动较大时，取较大的$\alpha$.

3.2 Holt指数平滑
二阶指数平滑：适用于序列有趋势特征但无季节性特征
Holt线性趋势模型
预测方程：$ \hat x_{t+h}=l_t+hb_t$
水平方程：l_t = $ \alpha x_t + (1-\alpha)(l_{t-1}+b_{t-1})$
趋势方程：b_t = $ \beta(l_t-l_{t-1}) + (1-\beta)b_{t-1}$
其中，$\alpha$代表水平平滑因子，$\beta$表示趋势平滑因子，控制趋势变化的影响。$l_t$代表时刻$t$的预估水平，$b_t$代表时刻$t$的预测趋势。
$\alpha$是水平的平滑参数，$\beta$是趋势的
指数趋势模型
阻尼趋势模型
乘法阻尼趋势

3.3 holt-winter指数平滑
三阶指数平滑: 使用于序列有趋势特征且有季节性特征
Holt-Winters加法模型
Holt-Winters乘法模型
Holt-Winters的衰减法 能预测多长时间的序列

4. ARMA Autoregressive moving average model
和去趋势话，以后变为平稳后怎么变回来一起考虑
AR(P):
在自回归变量种，基于对历史观测变量的线性组合对目标变量进行预测。
为什么AR模型要求自身平稳性？
自回归使用自身的数据进行预测，序列前后应当有相关性。所以多元线性回归模型预测时并不要求序列平稳，但AR模型则要求序列必须是平稳的。
偏自相关函数p阶截尾表明，变量只与前p个变量有关，因而也可以借助PACF确定AR模型的阶数p。
MA(q):
MA模型认为主要是受过去q期的误差项的影响。对于高阶的AR模型，有些可以用低阶的MA模型更好地描述。一般的AR模型也可以用高阶MA模型近似。MA模型同样要求序列宽平稳。

如何定阶？
1. ACF PACF
2. AIC BIC 信息最优

如何求参数？
。。。

ARMA公式: 

5. ARIMA Auto Regressive Integrated Moving Average
和ARMA的差别，就是多了一个非平稳序列转化为平稳的参数d ，表示d阶差分后转化为平稳序列。ARIMA 模型只是差分时间序列上的 ARMA 模型。

6. SARIMA
也就是在ARIMA的基础上，加入了季节性部分。季节性是指数据中具有固定频率的重复模式：每天、每两周、每四个月等重复的模式。

7. XGB LGBM CATboost

8. LSTM
可以输入多个特征值吗？下边的回答是肯定的
Prophet
 
RF 
ES 
SARIMAX 
 
 
CNN 
 
wavenet 
n-beats 
seq2seq 
fbprophet 


去季节话，去趋势化，
去趋势化
去季节化
检验季节化
缺失值
自相关 偏相关
平滑处理

小波变换 是解决什么问题的，怎么解决的，不同的参数都有什么样子的影响
小波变换的代码



小波去噪：
对于非平稳信号，傅里叶变换会有问题，一段信号总体上包含哪些频率的成分，但是对各成分出现的时刻并无所知，可以使用短时傅里叶变换，给时域的信号加窗，但是加多大的窗是不好确定的，
海森堡不确定性-鱼和熊掌不可兼得

而小波直接把傅里叶变换的基给换了——将无限长的三角函数基换成了有限长的会衰减的小波基。这样不仅能够获取频率，还可以定位到时间了~
傅里叶变换的本质：不同频率的基函数与时域信号做相关性，相关性值高，那么信号就含有这个频率的成分高。（这句话怎么理解）
小波变换：同时有了 频域和时域 两项
小波变换为什么可行：正交小波分解具有时-频局部分解的能力，在进行信号处理时，小波分量表现的幅度较大，与噪声在高频部分的均匀变现正好形成明显的对比。经小波分解后，幅值比较大的小波系数绝大多数是有用信号，而幅值较小的系数一般都是噪声，即可以认为有用信号的小波变换系数要大于噪声的小波变换系数。阈值去噪法就是找到一个合适的阈值，保留大于阈值的小波系数，将小于阈值的小波系数做相应的处理，然后，根据处理后的小波系数还原出有用信号。


### 白噪声检验


1. 均值

对于时间序列 $\lbrace X_t, t \in T \rbrace$ 来说,任意时刻的序列值 $X_t$ 都是一个随机变量，都有它自己的概率分布，记 $X_t$ 的分布函数 $F_t(x)$。只要满足$\int ^\infty_\infin x {\rm d}F_t(x) < \infin$

https://zhuanlan.zhihu.com/p/425664064
平稳性数据和非平稳性数据


补充：
平稳性数据的检验
数据准备


a. 白噪声，曲线围绕0值上下波动，波动幅度前后、上下一致，为平稳序列。
b. 随机游走，曲线无确定趋势，均值、方差波动较大，非平稳序列。
c. GDP数据趋势上升，均值随时间增加，非平稳序列。
d. GDP季节差分后数据，曲线大致在一条水平线上上下波动，波动幅度前后变化较小，可认为是平稳的。


AC（Autocorrelation Coefficient 自相关系数）: 用来描述数据自身不同时期的相关程度，即度量历史数据对现在产生的影响。
PCA（Partical Autocorrelation Coefficient 偏自相关系数）: 通自相关系数大同小异，在计算相关性时移除了中间变量的简介影响。
ACF（Autocorrelation Function 自相关函数）：自相关系数构成的序列。
自相关性使用
判断序列是否是平稳的
判断序列是否为白噪声
确定ARMA模型中的阶数（p/q）


